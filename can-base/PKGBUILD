pkgname=can-base
pkgver=6
pkgrel=1
pkgdesc="Meta-package with base system for an nspawn container."
arch=(any)
install=can-base.install

depends=(
	base

	less
	nano
	man-db
	man-pages
	diffutils
)


package() {
	cd "$pkgdir"

	# batman-adv with global IPv6 to run some overlay on top of
	mkdir -p etc/systemd/network
	ln -s /dev/null etc/systemd/network/80-container-host0.network
	cat >etc/systemd/network/50-bat.netdev <<'EOF'
[NetDev]
Name=bat0
Kind=batadv
MTUBytes=1440
EOF
	cat >etc/systemd/network/50-bat.network <<'EOF'
[Match]
Name=bat0

[Link]
MTUBytes=1440

[Network]
DHCP=no
LLMNR=no
LLDP=no
IPv6AcceptRA=no

## ip-ext ipv6-name -mbp 2a02:17d0:201:8b00::/64 can-name
# Address=2a02:17d0:201:8b00::/64
# Gateway=2a02:17d0:201:8b00:fc27:c46f:b9a4:a2d4
EOF
	cat >etc/systemd/network/66-ve-host.network <<'EOF'
[Match]
Name=host*
Virtualization=container

[Network]
DHCP=no
BatmanAdvanced=bat0
EOF

	# Workaround for systemd-networkd not setting mtu for these ifaces at the right time
	mkdir -p etc/systemd/system
	cat >etc/systemd/system/bat-mtu.service <<'EOF'
[Unit]
Wants=network.target
After=network.target
Before=network-online.target

StartLimitBurst=4
StartLimitIntervalSec=3min

[Service]
Type=exec

# systemd-networkd fails to set MTU via .netdev/network units consistently
# This script will try setting right mtu value whenever it tries to change
# rl= is for simple rate-limiting to bail on conflicting MTU setters
Environment=IF=bat0 MTU=1440
ExecStartPre=/usr/lib/systemd/systemd-networkd-wait-online -qi ${IF}:off --timeout 30
ExecStart=bash -c 'rl=0 rl_win=100 rl_max=20 rx=" mtu [0-9]+ "; \
	while read ev; do [[ "$ev" =~ $rx ]] || continue; \
		printf -v ts "%%(%%s)T" -1; ((ts-=ts%%rl_win)); ((rld=++rl-ts)); \
		[[ $rld -gt $rl_max ]] && exit 59 || [[ $rld -lt 0 ]] && rl=ts; \
		ip link set dev $IF mtu $MTU || break; \
	done < <(ip -o link show dev $IF; exec stdbuf -oL ip -o monitor link dev $IF)'

Restart=on-success
RestartSec=8

[Install]
WantedBy=multi-user.target
EOF
	mkdir -p etc/systemd/system/multi-user.target.wants
	ln -s /etc/systemd/system/bat-mtu.service etc/systemd/system/multi-user.target.wants/bat-mtu.service

}

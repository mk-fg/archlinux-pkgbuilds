pkgname=can-base
pkgver=5
pkgrel=2
pkgdesc="meta-package with base system for container machine."
arch=(any)

depends=(
	base

	bash
	coreutils
	diffutils
	file
	findutils
	gawk
	grep
	gzip
	iproute2
	iputils
	less
	man-db
	man-pages
	nano
	procps-ng
	sed
	sysfsutils
	tar
	texinfo
	util-linux
	libcap
	libarchive
	xz
	zstd

	batctl
	wireguard-tools
)

provides=()
conflicts=()
replaces=()

install=can-base.install


package() {
	cd "$pkgdir"

	# batman-adv with global IPv6 to run some overlay on top of
	mkdir -p etc/systemd/network
	ln -s /dev/null etc/systemd/network/80-container-host0.network
	cat >etc/systemd/network/50-bat.netdev <<'EOF'
[NetDev]
Name=bat0
Kind=batadv
MTUBytes=1440
EOF
	cat >etc/systemd/network/50-bat.network <<'EOF'
[Match]
Name=bat0

[Link]
MTUBytes=1440

[Network]
DHCP=no
LLMNR=no
LLDP=no
IPv6AcceptRA=no

## ip-ext ipv6-name -mbp 2a02:17d0:201:8b00::/64 can-name
# Address=2a02:17d0:201:8b00::/64
# Gateway=2a02:17d0:201:8b00:fc27:c46f:b9a4:a2d4
DNS=fd02::1
EOF
	cat >etc/systemd/network/66-ve-host.network <<'EOF'
[Match]
Name=host*
Virtualization=container

[Network]
DHCP=no
BatmanAdvanced=bat0
EOF

	# Workaround for systemd-networkd not setting mtu for these ifaces at the right time
	mkdir -p etc/systemd/system
	cat >etc/systemd/system/bat-mtu.service <<'EOF'
[Unit]
Wants=network.target
After=network.target
Before=network-online.target

[Service]
Type=oneshot
TimeoutSec=10

# systemd-networkd fails to set MTU via .netdev/network units
# This script will try setting mtu value a couple times, exiting when done or on timeout
ExecStart=bash -c 'iface=bat0; mtu=1440; err=1;\
	trap "pkill -g0" EXIT; trap \'err=0; pkill -g0\' USR1; trap \'exit $err\' TERM;\
	(grep -q " mtu $mtu " < <( ip link show dev $iface;\
		stdbuf -oL ip -o monitor all dev $iface ) && pkill -USR1 -g0 || pkill -g0) &\
	for n in 1 2 3 4; do read -rt 1 <> <(:); ip link set dev $iface mtu $mtu; done'

[Install]
WantedBy=multi-user.target
EOF
	mkdir -p etc/systemd/system/multi-user.target.wants
	ln -s /etc/systemd/system/bat-mtu.service etc/systemd/system/multi-user.target.wants/bat-mtu.service

}

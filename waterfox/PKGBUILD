## Based on the Waterfox from AUR by random-nick, which is in turn based on official firefox package in the repos.
# Waterfox Current tracks Firefox ESR releases: G3.2 = 78, G4.0 = 91
# Source repo: https://github.com/WaterfoxCo/Waterfox

pkgname=waterfox
pkgver=G4.0.1
pkgrel=1
pkgdesc="Fork of Mozilla Firefox featuring some legacy extensions, removed telemetry and no Pocket integration, current branch."
arch=(x86_64)
license=(MPL GPL LGPL)
url="https://www.waterfox.net/"
depends=(gtk3 libxt mime-types dbus-glib nss ttf-font)
makedepends=(
	unzip zip diffutils yasm mesa imake inetutils
	xorg-server-xvfb autoconf2.13 rust clang llvm lld
	cbindgen nasm libpulse nodejs dump_syms
	python python-psutil python-setuptools python-zstandard )
optdepends=(
	'libnotify: Notification integration'
	'libpulse: Audio support via Pulseaudio'
	'ffmpeg: Multimedia playback'
	'speech-dispatcher: Text-to-Speech'
	'hunspell-en_US: Spell checking, American English')
options=(!emptydirs !makeflags !strip)
_archivename=G4.0.1
source=(
	Waterfox-$_archivename.tar.gz::https://github.com/WaterfoxCo/Waterfox/archive/$_archivename.tar.gz
	$pkgname.desktop
	fix_G401_should_report_statistics_build_issue.patch )
sha256sums=(
	db0f3aede7f01336bcb3090fe00b2467c2561997426cd5f9cf8e1d53010aaf61
	3c8a3e73ffcb4670ca25fc7087b9c5d93ebbef2f3be8a33cf81ae424c3f27fa3
	SKIP )
#_disable_pgo=y # uncomment this to disable building the profiled browser and using PGO

local_patches=( fix_G401_should_report_statistics_build_issue.patch )
for p in 9999-*.patch ; do local_patches+=( $p ); source+=( $p ); sha256sums+=( SKIP ); done

prepare() {
	mkdir -p mozbuild
	cd Waterfox-$_archivename

	cat >../mozconfig <<END
# From .mozconfig in Waterfox repo

ac_add_options --target=x86_64-pc-linux-gnu

ac_add_options --disable-bootstrap
ac_add_options --disable-crashreporter
ac_add_options --disable-debug
ac_add_options --disable-dmd
ac_add_options --disable-geckodriver
ac_add_options --disable-jprof
ac_add_options --disable-profiling
ac_add_options --disable-tests
ac_add_options --disable-trace-logging
ac_add_options --disable-verify-mar
ac_add_options --disable-updater

ac_add_options --enable-application=browser
ac_add_options --enable-optimize="-Os -w"
ac_add_options --enable-rust-simd

MOZ_REQUIRE_SIGNING=


# Local tweaks

mk_add_options MOZ_OBJDIR=${PWD@Q}/obj
ac_add_options --prefix=/usr

ac_add_options --with-app-name=waterfox
ac_add_options --with-app-basename=Waterfox
ac_add_options --with-branding=browser/branding/waterfox
ac_add_options --with-l10n-base=$PWD/browser/locales/l10n

ac_add_options --enable-release
ac_add_options --enable-hardening
ac_add_options --enable-linker=lld
ac_add_options --with-system-nspr
ac_add_options --with-system-nss

ac_add_options --disable-alsa
ac_add_options --disable-jack


# Options for specific build pass follow
END

	for p in ${local_patches[@]}; do
		echo "--- applying local patch: $p"
		patch --dry-run -tNp1 -i "${srcdir}"/$p && patch -tNp1 -i "${srcdir}"/$p
	done
}

build() {
	cd Waterfox-$_archivename

	export MOZ_NOSPAM=1
	export MOZBUILD_STATE_PATH="$srcdir/mozbuild"
	export MACH_USE_SYSTEM_PYTHON=1

	# LTO needs more open files
	ulimit -n 4096

	# suppress warnings
	CFLAGS+=" -w"
	CXXFLAGS+=" -w"

	if [[ -z $_disable_pgo ]]; then
	# Do 3-tier PGO
	echo "Building instrumented browser..."
	cat >.mozconfig ../mozconfig - <<END
ac_add_options --enable-profile-generate=cross
END
	./mach build
	./mach package

	echo "Profiling instrumented browser..."
	LLVM_PROFDATA=llvm-profdata \
		JARLOG_FILE="$PWD/jarlog" \
		xvfb-run -s "-screen 0 1920x1080x24 -nolisten local" \
		./mach python build/pgo/profileserver.py
	echo "Merging profile data..."
	for i in *.profraw; do
		stat -c "Raw profile data file $i found (%s bytes)" $i
	done
	llvm-profdata merge -o merged.profdata *.profraw

	if [[ ! -s merged.profdata ]]; then
		echo "No profile data produced."
		return 1
	fi
	stat -c "Profile data found (%s bytes)" merged.profdata

	if [[ ! -s jarlog ]]; then
		echo "No jarlog produced."
		return 1
	fi
	stat -c "Profile jarlog found (%s bytes)" jarlog

	echo "Removing instrumented browser..."
	./mach clobber

	echo "Building optimized browser..."
	cat >.mozconfig ../mozconfig - <<END
ac_add_options --enable-lto=cross
ac_add_options --enable-profile-use=cross
ac_add_options --with-pgo-profile-path=${PWD@Q}/merged.profdata
ac_add_options --with-pgo-jarlog=${PWD@Q}/jarlog
END
	else
	echo "Building browser without PGO..."
	cat >.mozconfig ../mozconfig - <<END
ac_add_options --enable-lto=cross
END
	fi
	./mach build
}

package() {
	cd Waterfox-$_archivename
	DESTDIR="$pkgdir" ./mach install

	local vendorjs="$pkgdir/usr/lib/$pkgname/browser/defaults/preferences/vendor.js"
	install -Dvm644 /dev/stdin "$vendorjs" <<END
// Use LANG environment variable to choose locale
pref("intl.locale.requested", "");

// Use system-provided dictionaries
pref("spellchecker.dictionary_path", "/usr/share/hunspell");

// Disable default browser checking.
pref("browser.shell.checkDefaultBrowser", false);

// Don't disable extensions in the application directory
pref("extensions.autoDisableScopes", 11);
END

	local distini="$pkgdir/usr/lib/$pkgname/distribution/distribution.ini"
	install -Dvm644 /dev/stdin "$distini" <<END
[Global]
id=archlinux
version=1.0
about=Waterfox for Arch Linux

[Preferences]
app.distributor=archlinux
app.distributor.channel=$pkgname
END

	local i theme=waterfox
	for i in 16 32 48 64 128; do
		install -Dvm644 browser/branding/$theme/default$i.png \
			"$pkgdir/usr/share/icons/hicolor/${i}x${i}/apps/$pkgname.png"
	done
	install -Dvm644 browser/branding/$theme/content/about-logo.png \
		"$pkgdir/usr/share/icons/hicolor/192x192/apps/$pkgname.png"
	install -Dvm644 browser/branding/$theme/content/about-logo@2x.png \
		"$pkgdir/usr/share/icons/hicolor/384x384/apps/$pkgname.png"
	install -Dvm644 browser/branding/$theme/content/about-logo.svg \
		"$pkgdir/usr/share/icons/hicolor/scalable/apps/$pkgname.svg"

	install -Dvm644 ../$pkgname.desktop \
		"$pkgdir/usr/share/applications/$pkgname.desktop"

	# Install a wrapper to avoid confusion about binary path
	install -Dvm755 /dev/stdin "$pkgdir/usr/bin/$pkgname" <<END
#!/bin/sh
exec /usr/lib/$pkgname/waterfox "\$@"
END

	# Replace duplicate binary with wrapper
	# https://bugzilla.mozilla.org/show_bug.cgi?id=658850
	ln -srfv "$pkgdir/usr/bin/$pkgname" "$pkgdir/usr/lib/$pkgname/waterfox-bin"

	# Use system certificates
	local nssckbi="$pkgdir/usr/lib/$pkgname/libnssckbi.so"
	if [[ -e $nssckbi ]]; then
		ln -srfv "$pkgdir/usr/lib/libnssckbi.so" "$nssckbi"
	fi
}
